#!/bin/bash

get_repo_list() {
    find ~/src -maxdepth 1 -type d -exec basename {} \; | sed '1d'
}

repo() {
    if [ $# -eq 0 ]; then
        local selected_repo=$(get_repo_list | fzf --height 40% --reverse)
        if [ -z "$selected_repo" ]; then
            echo "No repository selected."
            return 1
        fi
        set -- "$selected_repo"
    fi

    local restart_flag=""
    if [[ "$1" == "--restart" || "$1" == "-r" ]]; then
        restart_flag="$1"
        shift
    elif [[ "$2" == "--restart" || "$2" == "-r" ]]; then
        restart_flag="$2"
    fi

    echo session $restart_flag "$1" "~/src/$1/" "nvim" "ls" 
    session $restart_flag "$1" ~/src/"$1"/ "nvim" "ls" 
}

_repo_autocomplete() {
    local cur=${COMP_WORDS[COMP_CWORD]}
    COMPREPLY=( $(compgen -W "$(get_repo_list)" -- "$cur") )
}

# Check if the script is being sourced
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    # If the script is executed directly, run the repo function
    repo "$@"
else
    # If the script is sourced, set up the completion
    complete -F _repo_autocomplete repo
fi
